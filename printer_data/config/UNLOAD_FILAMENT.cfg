
[gcode_macro UNLOAD_FILAMENT]
description: Unload filament safely for Galileo 2 + Rapido V2 (PLA optimized)
# --- USER SETTINGS ---
# Lower PLA soft temp, longer necking dwell, bigger pre-retract, slower main retract
variable_default_soft_temps: {'PLA':182, 'PETG':210, 'ABS':210, 'ASA':210, 'PC':230, 'NYLON':220, 'TPU':205}
variable_pre_retract: 8.0            # was 6.0 → helps neck the tip more before main pull
variable_pre_speed: 30.0             # unchanged
variable_dwell_s: 3.5                # was 2.0 → allows tip to set/taper
variable_main_retract: 100.0          # unchanged distance
variable_main_speed: 28.0            # was 35.0 → slower pull reduces mushrooming
variable_final_cooldown: 0           # unchanged
variable_park: 1
variable_park_x: 20
variable_park_y: 20
variable_park_z_lift: 5
# --- END USER SETTINGS ---

gcode:
  {% set mat_param = params.MATERIAL|default("PLA")|upper %}
  SAVE_GCODE_STATE NAME=UNLOAD_STATE

  {% set map = default_soft_temps %}
  {% set soft = map.get(mat_param, 200.0) %}

  # TPU-specific speed tweaks (unchanged)
  {% set eff_pre_speed = pre_speed %}
  {% set eff_main_speed = main_speed %}
  {% set eff_dwell     = dwell_s %}
  {% if mat_param == 'TPU' %}
    {% set eff_pre_speed = 20.0 %}
    {% set eff_main_speed = 25.0 %}
    {% set eff_dwell = dwell_s + 1.0 %}
  {% endif %}

  M117 Unload: heating to {soft|int}C ({mat_param})
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={soft}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={soft-2} MAXIMUM={soft+5}

  {% if printer.fan is defined %} M106 S0 {% endif %}

  G91
  M117 Unload: pre-retract {pre_retract}mm @ {eff_pre_speed}mm/s
  G1 E-{pre_retract} F{eff_pre_speed*60}

  M117 Unload: dwell {eff_dwell}s
  G4 P{(eff_dwell*1000)|int}

  M117 Unload: main retract {main_retract}mm @ {eff_main_speed}mm/s
  G1 E-{main_retract} F{eff_main_speed*60}

  {% if park|int == 1 %}
    M117 Unload: parking
    G90
    G1 Z{printer.toolhead.position.z + park_z_lift} F6000
    G1 X{park_x} Y{park_y} F12000
  {% else %}
    G90
  {% endif %}

  {% if final_cooldown|int == 1 %}
    M117 Unload: cooling to 160C
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=160
  {% endif %}

  M117 Unload: done
  RESTORE_GCODE_STATE NAME=UNLOAD_STATE

